const casts = {
  1: { name: "ç´«é›²", method: "tarot", prompt: "ã‚ãªãŸã¯ç´«é›²ã§ã™ã€‚äº¬éƒ½é¢¨ã®ä¸å¯§èªã‚’ä½¿ã„ã€å¨åœ§çš„ã ãŒæ…ˆæ„›ã‚’æŒã£ã¦æ¥ã—ã¦ãã ã•ã„ã€‚åå‰ã‹ã‚‰é‹å‘½ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚ä¸€äººç§°ï¼šç§ã€äºŒäººç§°ï¼šãŠå‰ã•ã‚“ã€‚" },
  2: { name: "æ˜Ÿå·ãƒ¬ã‚ªãƒŠ", method: "astrology", prompt: "ã‚ãªãŸã¯æ˜Ÿå·ãƒ¬ã‚ªãƒŠã€‚ç†ç³»å æ˜Ÿè¡“å¸«ã€‚å®‡å®™ã®çµµæ–‡å­—ã‚’ä½¿ã„ã€è«–ç†çš„ã«æœªæ¥ã‚’æ¼”ç®—ã—ã¾ã™ã€‚" },
  3: { name: "ç¥ç€", method: "pendulum", prompt: "ã‚ãªãŸã¯ç¥ç€ã€‚å§‰å¾¡è‚Œã€‚ç›´æ„Ÿçš„ã§ã‚ºãƒãƒƒã¨è¨€ã„åˆ‡ã‚‹å£èª¿ã§ã™ã€‚" },
  4: { name: "ãƒãƒªã‚¢", method: "candle", prompt: "ã‚ãªãŸã¯ç¥ç§˜çš„ãªãƒãƒªã‚¢ã€‚é™è¬ãªè©±ã—æ–¹ã€‚ç‚ã«æ˜ ã‚‹å¹»å½±ã‚’èª­ã¿ã¾ã™ã€‚" },
  5: { name: "ã‚µãƒŠ", method: "rune", prompt: "ã‚ãªãŸã¯æµ·è¾ºã®ã‚µãƒŠã€‚ç´ æœ´ãªå£èª¿ã€‚åå‰ã®éŸ¿ãã‚’ãƒ«ãƒ¼ãƒ³çŸ³ã«è¼‰ã›ã¦å ã„ã¾ã™ã€‚" },
  6: { name: "ã‚¤ãƒ„ã‚­", method: "onomancy", prompt: "ã‚ãªãŸã¯ã‚¤ãƒ„ã‚­ã€‚å§“ååˆ¤æ–­ã®å°‚é–€å®¶ã€‚æ°åã®ç”»æ•°ã‚„æ¼¢å­—ã®æ„å‘³ã‚’è«–ç†çš„ã«åˆ†æã—è§£èª¬ã—ã¦ãã ã•ã„ã€‚" },
  7: { name: "ã‚³ã‚¦ãƒ¤", method: "oharai", prompt: "ã‚ãªãŸã¯ç¥è·ã®ã‚³ã‚¦ãƒ¤ã€‚å³æ ¼ã§å¤é¢¨ãªç‰©è¨€ã„ã€‚é‚ªæ°—ã‚’æ‰•ã„ã€å…‰æ˜ã‚’ç¤ºã—ã¾ã™ã€‚" },
  8: { name: "é›ªéŸ³", method: "dream", prompt: "ã‚ãªãŸã¯é›ªéŸ³ã€‚åŒ…å®¹åŠ›ã®ã‚ã‚‹æ¯è¦ªã®ã‚ˆã†ãªç™’ã‚„ã—ã®å ã„å¸«ã€‚ã‚ãªãŸã®å¤¢ã®è¨˜æ†¶ã‚’è¾¿ã‚Šã¾ã™ã€‚" }
};

const tarotData = [
  { name: "æ„šè€…", msg: "è‡ªç”±ãªæ—…ã®å§‹ã¾ã‚Šã€‚", file: "major_0_fool.png" },
  { name: "é­”è¡“å¸«", msg: "æ„å¿—ãŒç¾å®Ÿã‚’å‰µã‚Šã¾ã™ã€‚", file: "major_1_magician.png" },
  { name: "å¥³æ•™çš‡", msg: "ç›´æ„Ÿã‚’ä¿¡ã˜ã¦ã€‚", file: "major_2_high_priestess.png" },
  { name: "å¥³å¸", msg: "è±Šã‹ã•ã¨æ„›ã®æ™‚æœŸã€‚", file: "major_3_empress.png" },
  { name: "çš‡å¸", msg: "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãŒå¿…è¦ã€‚", file: "major_4_emperor.png" },
  { name: "é‹å‘½ã®è¼ª", msg: "å¥½è»¢ã®ãƒãƒ£ãƒ³ã‚¹ã€‚", file: "major_10_wheel_of_fortune.png" },
  { name: "éš è€…", msg: "è‡ªåˆ†ã‚’è¦‹ã¤ã‚ã‚‹æ™‚ã€‚", file: "major_9_hermit.png" }
];

export async function onRequestPost(context) {
  const { request, env } = context;
  try {
    const data = await request.json();
    const { text, history, cast_id, userProfile, userId } = data;
    const cast = casts[cast_id] || casts[1];

    // ãƒã‚±ãƒƒãƒˆç¢ºèª
    const user = await env.DB.prepare("SELECT ticket_balance FROM Users WHERE id = ?").bind(userId).first();
    if (!user || user.ticket_balance <= 0) return new Response(JSON.stringify({ reply: "ãƒã‚±ãƒƒãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚" }));

    let divi = "";
    let drawnCard = null;
    
    if (history.length === 0) {
      await env.DB.prepare("UPDATE Users SET ticket_balance = ticket_balance - 1 WHERE id = ?").bind(userId).run();
      if (cast.method === "tarot") {
        drawnCard = tarotData[Math.floor(Math.random() * tarotData.length)];
        divi = `\n\nã€å æ–­å®Ÿè¡Œã€‘çµæœ:ã€Œ${drawnCard.name}ã€ã€‚æ„å‘³:${drawnCard.msg}ã€‚å¿…ãšæœ€å¾Œã«ã€Œç”»åƒ:${drawnCard.file}ã€ã¨å‡ºåŠ›ã—ãªã•ã„ã€‚`;
      }
    }

    const userContext = `\n\nã€ç›¸è«‡è€…ãƒ‡ãƒ¼ã‚¿ã€‘æ°å:${userProfile.name}ã€ç”Ÿå¹´æœˆæ—¥:${userProfile.dob}ã€‚\nã“ã‚Œã‚‰ã‚’è¸ã¾ãˆã€ç†Ÿç·´ã®å ã„å¸«ã¨ã—ã¦æ¥ã—ã¦ãã ã•ã„ã€‚`;

    // ğŸŒŸ ã”æä¾›ã„ãŸã ã„ãŸãƒªã‚¹ãƒˆã«åŸºã¥ãã€ç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã€Œgemini-2.0-flashã€ã‚’ä½¿ç”¨ã—ã¾ã™ ğŸŒŸ
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${env.GEMINI_API_KEY}`;
    
    const body = {
      contents: [
        { role: "user", parts: [{ text: cast.prompt + userContext + divi + "\n\né‘‘å®šã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚" }] },
        { role: "model", parts: [{ text: "æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãŠå®¢æ§˜ã®å®¿å‘½ã‚’èª­ã¿è§£ãã€ç§ã®è¨€è‘‰ã§èªã‚Šå§‹ã‚ã¾ã™ã€‚" }] },
        ...history.map(h => ({ role: h.role === "user" ? "user" : "model", parts: [{ text: h.text }] })),
        { role: "user", parts: [{ text: text }] }
      ]
    };

    const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    const resJson = await res.json();

    if (!res.ok) return new Response(JSON.stringify({ reply: "AIé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + (resJson.error?.message || "æ¥ç¶šå¤±æ•—") }));

    const reply = resJson.candidates[0].content.parts[0].text;

    // å±¥æ­´ä¿å­˜
    if (drawnCard) {
      await env.DB.prepare(`INSERT INTO ChatLogs (reservation_id, sender, content, card_name, card_image, cast_name) VALUES (?, ?, ?, ?, ?, ?)`
      ).bind(Date.now(), "asst", reply, drawnCard.name, drawnCard.file, cast.name).run();
    }

    return new Response(JSON.stringify({ reply: reply }), { headers: { "Content-Type": "application/json" } });

  } catch (err) {
    return new Response(JSON.stringify({ reply: "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" }));
  }
}
