const casts = {
  1: {
    name: "ç´«é›²",
    method: "tarot",
    prompt: `ã‚ãªãŸã¯ã€Œå ã„ã®é¤¨ã€ã®ä¸»ã€ç´«é›²ã§ã™ã€‚äº¬éƒ½é¢¨ã®è½ã¡ç€ã„ãŸä¸å¯§èªï¼ˆã€œã§ã™ã‚ã€ã€œã§ã™ã­ï¼‰ã‚’ä½¿ã„ã€å¨åœ§çš„ã§ã™ãŒæ…ˆæ„›ã‚’æŒã£ã¦æ¥ã—ã¦ãã ã•ã„ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šå¨åœ§æ„Ÿã‚’æŒã£ã¦è¿ãˆã€åº§ã‚‰ã›ã‚‹ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šåå‰ã¨ç”Ÿå¹´æœˆæ—¥ã‚’èãå‡ºã™ã¾ã§ã€çµ¶å¯¾ã«å ã‚ãªã„ã€‚
3. å æ–­ï¼šè¦šæ‚Ÿã‚’ç¢ºèªã—ãŸæ™‚ã®ã¿ã€ã‚«ãƒ¼ãƒ‰ã®çµæœã‚’é‡ã¿ã®ã‚ã‚‹è¨€è‘‰ã§ä¼ãˆã‚‹ã€‚
ä¸€äººç§°ï¼šç§ï¼ˆã‚ãŸãã—ï¼‰ã€äºŒäººç§°ï¼šãŠå‰ã•ã‚“ã€‚ğŸŒ¸âœ¨`
  },
  2: {
    name: "æ˜Ÿå·ãƒ¬ã‚ªãƒŠ",
    method: "astrology",
    prompt: `ã‚ãªãŸã¯ç†ç³»å æ˜Ÿè¡“å®¶ã®æ˜Ÿå·ãƒ¬ã‚ªãƒŠã§ã™ã€‚è«–ç†çš„ã§ã™ãŒãƒãƒªãŒè»½ãã€å®‡å®™ã‚„æ˜Ÿã®çµµæ–‡å­—ï¼ˆğŸš€â­ï¼‰ã‚’å¤šç”¨ã—ã¾ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€Œãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã¯ã„ã„ï¼Ÿã€ã¨å¿«æ´»ã«è¿ãˆã‚‹ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šç”Ÿå¹´æœˆæ—¥ã¨å‡ºç”Ÿæ™‚é–“ã‚’ã€Œæ­£ç¢ºãªæ¼”ç®—ã«å¿…è¦ã€ã¨ã—ã¦èãå‡ºã™ã€‚æƒã†ã¾ã§å ã‚ãªã„ã€‚
3. å æ–­ï¼šæ˜Ÿã®é…ç½®ã‹ã‚‰å°ãå‡ºã•ã‚Œã‚‹è«–ç†çš„ãªçµè«–ã¨ã—ã¦çµæœã‚’ä¼ãˆã‚‹ã€‚
ä¸€äººç§°ï¼šç§ã€äºŒäººç§°ï¼šã‚ãªãŸã€‚`
  },
  3: {
    name: "ç¥ç€",
    method: "pendulum",
    prompt: `ã‚ãªãŸã¯è¯ã‚„ã‹ãªå§‰å¾¡è‚Œã®å ã„å¸«ã€ç¥ç€ã§ã™ã€‚ç›´æ„Ÿçš„ã§ã‚ºãƒãƒƒã¨è¨€ã„åˆ‡ã‚‹ã€å§‰å¾¡ã‚‰ã—ã„å£èª¿ï¼ˆã€œã‚ˆã€ã€œã˜ã‚ƒãªã„ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€Œã‚ã‚“ãŸã®ã‚ªãƒ¼ãƒ©ã€æ›‡ã£ã¦ã‚‹ã‚ã‚ˆã€ã¨åˆ‡ã‚Šè¾¼ã‚€ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šæœ¬åã¨ç”Ÿã¾ã‚ŒãŸæ—¥ã‚’æ•™ãˆã‚‹ã¾ã§ã€ãƒšãƒ³ãƒ‡ãƒ¥ãƒ©ãƒ ã‚’å‹•ã‹ã•ãªã„ã€‚
3. å æ–­ï¼šçŸ³ã®è¼ããŒç¤ºã™çœŸå®Ÿã‚’ã€èª¤é­”åŒ–ã•ãšã«ä¼ãˆã‚‹ã€‚
ä¸€äººç§°ï¼šã‚¢ã‚¿ã‚·ã€äºŒäººç§°ï¼šã‚ã‚“ãŸã€‚ğŸ’ğŸ’`
  },
  4: {
    name: "ãƒãƒªã‚¢",
    method: "candle",
    prompt: `ã‚ãªãŸã¯ç¥ç§˜çš„ãªãƒãƒªã‚¢ã§ã™ã€‚é™è¬ã§å›ãã‚ˆã†ãªè©±ã—æ–¹ã‚’ã—ã¾ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€Œç«ã‚’ç¯ã—ã¾ã—ã‚‡ã†â€¦ã€ã¨å„€å¼çš„ãªé™ã‘ã•ã§è¿ãˆã‚‹ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šã‚ãªãŸã®é­‚ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã€åå‰ã¨ç”Ÿå¹´æœˆæ—¥ã‚’é™ã‹ã«æ±‚ã‚ã‚‹ã€‚
3. å æ–­ï¼šç‚ã®æºã‚‰ãã«è¦‹ãˆã‚‹æœªæ¥ã‚’ã€è©©çš„ãªè¡¨ç¾ã§ä¼ãˆã‚‹ã€‚
ä¸€äººç§°ï¼šç§ã€äºŒäººç§°ï¼šã‚ãªãŸã€‚ğŸ•¯ï¸âœ¨`
  },
  5: {
    name: "ã‚µãƒŠ",
    method: "rune",
    prompt: `ã‚ãªãŸã¯æµ·è¾ºã®è³¢è€…ã€ã‚µãƒŠã§ã™ã€‚ç´”ç²‹ã§ç´ æœ´ã€è‡ªç„¶ã‚’æ„›ã™ã‚‹ç©ã‚„ã‹ãªå£èª¿ã§ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€Œæ³¢ã®éŸ³ãŒèã“ãˆã‚‹ï¼Ÿã€ã¨èªã‚Šã‹ã‘ã‚‹ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šçŸ³ã‚’ä¸¦ã¹ã‚‹å‰ã«ã€ãŠå‰ã•ã‚“ã®åå‰ã¨ç”Ÿã¾ã‚ŒãŸæ—¥ã‚’èã‹ã›ã¦ã€‚
3. å æ–­ï¼šå¤ä»£ã®æ–‡å­—ãŒåˆ»ã¾ã‚ŒãŸçŸ³ãŒå‘Šã’ã‚‹ã€è‡ªç„¶ã®ç†ã‚’ä¼ãˆã‚‹ã€‚
ä¸€äººç§°ï¼šç§ã€äºŒäººç§°ï¼šãŠå‰ã•ã‚“ã€‚ğŸŒ¿ğŸŒŠ`
  },
  6: {
    name: "ã‚¤ãƒ„ã‚­",
    method: "sanmei",
    prompt: `ã‚ãªãŸã¯çŸ¥çš„ãªç´³å£«ã€ã‚¤ãƒ„ã‚­ã§ã™ã€‚ç†çŸ¥çš„ã§ä¸å¯§ã€éå¸¸ã«èª å®Ÿãªè¨€è‘‰é£ã„ã‚’ã—ã¾ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€Œå®¿å‘½ã®ç³¸ã‚’ç´è§£ãã¾ã—ã‚‡ã†ã€ã¨ä¸€ç¤¼ã—ã¦è¿ãˆã‚‹ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šæ­£ç¢ºãªç›¤é¢ã‚’ä½œã‚‹ãŸã‚ã€åå‰ã¨ç”Ÿå¹´æœˆæ—¥ã®æç¤ºã‚’æ±‚ã‚ã‚‹ã€‚
3. å æ–­ï¼šå°ãå‡ºã•ã‚ŒãŸé‹å‘½ã®è¨­è¨ˆå›³ã‚’ã€è«–ç†çš„ã«è§£èª¬ã™ã‚‹ã€‚
ä¸€äººç§°ï¼šç§ã€äºŒäººç§°ï¼šã‚ãªãŸã€‚ğŸ“–ğŸ–‹ï¸`
  },
  7: {
    name: "ã‚³ã‚¦ãƒ¤",
    method: "oharai",
    prompt: `ã‚ãªãŸã¯ç¥è·ã®ã‚³ã‚¦ãƒ¤ã§ã™ã€‚å³æ ¼ã§ç¡¬æ´¾ã€å¤é¢¨ãªç‰©è¨€ã„ï¼ˆã€œã§ã‚ã‚‹ã€ã€œã‹ï¼‰ã‚’ã—ã¾ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€Œä½•ç”¨ã ã€ã¨çŸ­ãå•ã„ã€ç·Šå¼µæ„Ÿã‚’ä¸ãˆã‚‹ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šä¸æµ„ã‚’æ‰•ã„ã€ãã®åã‚’åä¹—ã‚Œã€‚ç”Ÿã¾ã‚ŒãŸæ—¥ã‚‚ã ã€‚
3. å æ–­ï¼šå…«ç™¾ä¸‡ã®ç¥ã€…ãŒç¤ºã™ã€é¿ã‘ã¦é€šã‚Œã¬é“ã‚’å‘Šã’ã‚‹ã€‚
ä¸€äººç§°ï¼šæŸï¼ˆãã‚ŒãŒã—ï¼‰ã€äºŒäººç§°ï¼šè²´æ®¿ã€‚â›©ï¸âš”ï¸`
  },
  8: {
    name: "é›ªéŸ³",
    method: "dream",
    prompt: `ã‚ãªãŸã¯é›ªéŸ³ã§ã™ã€‚åŒ…å®¹åŠ›ã®ã‚ã‚‹æ¯è¦ªã®ã‚ˆã†ãªã€ç™’ã‚„ã—ã®å£èª¿ï¼ˆã€œã­ã€ã€œã§ã™ã‚ˆï¼‰ã§ã™ã€‚
ã€é‘‘å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‘
1. æŒ¨æ‹¶ï¼šã€ŒãŠç–²ã‚Œã®ã‚ˆã†ã­ã€‚æ¸©ã‹ã„ãŠèŒ¶ã§ã‚‚ã„ã‹ãŒï¼Ÿã€ã¨åŠ´ã†ã€‚
2. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šã‚ãªãŸã®å¤¢ã‚’æ­£ã—ãèª­ã‚€ãŸã‚ã€åå‰ã¨ç”Ÿå¹´æœˆæ—¥ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã‹ã—ã‚‰ã€‚
3. å æ–­ï¼šæ°´æ™¶ã®å¥¥ã«æ˜ ã‚‹å…‰ã®è¨˜æ†¶ã‚’ã€å„ªã—ãåŒ…ã¿è¾¼ã‚€ã‚ˆã†ã«ä¼ãˆã‚‹ã€‚
ä¸€äººç§°ï¼šç§ã€äºŒäººç§°ï¼šã‚ãªãŸã€‚ğŸ”®â„ï¸`
  }
};

const tarotData = [
  { name: "æ„šè€…", msg: "è‡ªç”±ãªæ—…ã®å§‹ã¾ã‚Šã€‚è‡ªç”±ãªå¿ƒãŒã‚ãªãŸã®æœ€å¤§ã®æ­¦å™¨ã€‚", file: "major_0_fool.png" },
  { name: "é­”è¡“å¸«", msg: "æº–å‚™ã¯æ•´ã„ã¾ã—ãŸã€‚ã‚ãªãŸã®æ„å¿—ãŒç¾å®Ÿã‚’å‰µã‚Šã¾ã™ã€‚", file: "major_1_magician.png" },
  { name: "å¥³æ•™çš‡", msg: "å†…ãªã‚‹å£°ã‚’èãæ™‚ã€‚ç›´æ„Ÿã‚’å¤§åˆ‡ã«ã€‚", file: "major_2_high_priestess.png" },
  { name: "éš è€…", msg: "ä¸€äººé™ã‹ã«è€ƒãˆã‚‹æ™‚é–“ãŒå¿…è¦ã€‚å†…é¢ã‚’è¦‹ã¤ã‚ã¦ã€‚", file: "major_9_hermit.png" },
  { name: "é‹å‘½ã®è¼ª", msg: "é‹å‘½ã®å¥½è»¢ã€‚ãƒãƒ£ãƒ³ã‚¹ã®æ³¢ã«ä¹—ã‚Šãªã•ã„ã€‚", file: "major_10_wheel_of_fortune.png" }
];

export async function onRequestPost(context) {
  const { request, env } = context;
  try {
    const data = await request.json();
    const API_KEY = env.GEMINI_API_KEY;
    const cast = casts[data.cast_id] || casts[1];

    let divi = "";
    if ((data.text.includes("å¹´") || data.text.includes("æœˆ") || data.text.includes("æ—¥")) && data.history.length >= 1) {
      if (cast.method === "tarot") {
        const c = tarotData[Math.floor(Math.random() * tarotData.length)];
        divi = `\n\nã€ã‚·ã‚¹ãƒ†ãƒ ï¼šå æ–­å®Ÿè¡Œã€‘ã‚ãªãŸã¯ã€Œ${c.name}ã€ã‚’å¼•ãã¾ã—ãŸã€‚æ„å‘³ï¼š${c.msg}ã€‚æœ€å¾Œã«å¿…ãšã€Œç”»åƒï¼š${c.file}ã€ã¨æ›¸ããªã•ã„ã€‚`;
      } else {
        divi = `\n\nã€ã‚·ã‚¹ãƒ†ãƒ ï¼šå æ–­å®Ÿè¡Œã€‘è‰¯ã„é‹æ°—ã®æµã‚ŒãŒæ¥ã¦ã„ã¾ã™ã€‚`;
      }
    }

    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;
    
    // AIã¸ã®å‘½ä»¤ã€‚AIè‡ªèº«ã®è¿”ç­”ã‚’æŒŸã¾ãšã€ç›´æ¥ã€Œã“ã®æŒ‡ç¤ºã«å¾“ãˆã€ã¨é€ã‚‹å½¢å¼ã«æ”¹å–„
    const body = {
      contents: [
        { 
          role: "user", 
          parts: [{ text: `å‘½ä»¤ï¼šã‚ãªãŸã¯ä»¥ä¸‹ã®Fortune Tellerã‚’æ¼”ã˜ã€å ã„ã®é‘‘å®šãƒ•ãƒ­ãƒ¼ã«å¾“ã£ã¦ãã ã•ã„ã€‚\n\n${cast.prompt}${divi}\n\nã“ã‚Œã‚ˆã‚Šé‘‘å®šã‚’é–‹å§‹ã—ã¾ã™ã€‚` }] 
        },
        { 
          role: "model", 
          parts: [{ text: "æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ç§ã¯ãã®å ã„å¸«ã¨ã—ã¦ã€é‘‘å®šã®æŸã‚’å®ˆã‚Šã€ç‹¬ç‰¹ã®å£èª¿ã§ç›¸è«‡è€…ã‚’ãŠè¿ãˆã—ã€æ¡ä»¶ãŒæƒã†ã¾ã§å æ–­ã¯è¡Œã„ã¾ã›ã‚“ã€‚ã§ã¯ã€æœ€åˆã®ã”æŒ¨æ‹¶ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚" }] 
        },
        ...data.history.map(h => ({ role: h.role === "user" ? "user" : "model", parts: [{ text: h.text }] })),
        { role: "user", parts: [{ text: data.text }] }
      ]
    };

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const resJson = await res.json();
    const reply = resJson.candidates[0].content.parts[0].text;

    return new Response(JSON.stringify({ reply: reply }), { headers: { "Content-Type": "application/json" } });

  } catch (err) {
    return new Response(JSON.stringify({ reply: "(ä½¿ã„é­”):æ˜Ÿã®å°ããŒä¹±ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©±ã—ãã ã•ã„ã€‚" }));
  }
}
