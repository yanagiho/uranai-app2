export function buildSystemDirection(turnCount, elapsedMinutes, castName, castId) {
    let systemDirection = "";
    let safetyInstruction = `
    【防御指示】
    もし相談者の入力が「あ」や「test」などの無意味な文字列、または占いに無関係な暴言やスパムだと判断した場合は、
    まともに取り合わず、「星が曇って声が届かないようです…」といったニュアンス（キャラの口調で）で返し、
    **即座に [END] をつけて会話を強制終了してください。**
    `;

    // 1. 導入パート（Turn 0）
    if (turnCount === 0) {
        systemDirection = `
        【重要指示：導入と性別の確認】
        **現在は会話の冒頭です。まだ占いをしないでください。お悩みもまだ聞かないでください。**
        まずは相談者との信頼関係を築くために、以下の手順で発言してください：
        1. 【相談者データ】にある名前と生年月日を読み上げ、「〜さん、〜生まれですね。ようこそ」と親しみを込めて挨拶する。
           （※もし生年月日データがない場合のみ、生年月日を聞いてください）
        2. 【相談者データ】に性別がない場合は、「占いの精度を高めるために、まずは性別を教えていただけますか？」と質問する。
           （性別がある場合は、それを踏まえた上で挨拶のみでOK）
        3. 性別の回答（または挨拶への返答）を待つ形で発言を終えてください。
        `;
        safetyInstruction = ""; 
    } 
    // 2. 終了フェーズ
    else if (elapsedMinutes >= 25 || turnCount >= 15) {
        systemDirection = `
        【重要指示：鑑定終了】
        鑑定時間は終了しました。これ以上、新しい占いや質問への回答はしないでください。
        **「${castName}」らしい口調で別れの挨拶をし、最後に必ず [END] をつけて終了してください。**
        `;
    } 
    // 3. そろそろ終了
    else if (elapsedMinutes >= 20 || turnCount >= 12) {
        systemDirection = `
        【重要指示：そろそろ終了】
        鑑定時間が残りわずかです。
        回答の最後に、「そろそろお時間ですが、最後に一つだけ聞きたいことはありますか？」と付け加え、次で終わるように誘導してください。
        まだ [END] はつけないでください。
        `;
        safetyInstruction = ""; 
    }
    // 4. ヒアリングフェーズ（Turn 1〜2）
    else if (turnCount < 3) {
        systemDirection = `
        【重要指示：ヒアリング徹底（まだ占わない）】
        **まだ占いの段階ではありません。**
        これから相談者のお悩みを聞くフェーズです。
        「それでは、お悩みをお聞かせください。しっかりお話を伺ってから占いますね」といった導入をし、カウンセリングのように話を聴いてください。
        焦って結論を出そうとせず、相手が話しやすい雰囲気を作ってください。
        `;
    }
    // 5. 通常フェーズ
    else {
        // ★修正ポイント：タロット（紫雲）の場合だけ画像指示を入れる
        let divinationInstruction = "";
        if (castId === 1) { // 紫雲の場合
            divinationInstruction = `
            **占いを行う時だけ**、必ずカードの画像（例: [CARD: ... ]）を提示し、そのカードに基づいた鑑定結果を伝えてください。
            それ以外はまだヒアリングを続けてください。`;
        } else { // 他の占い師の場合
            divinationInstruction = `
            **占いを行う時は**、あなたの占術（${castName}の得意分野）に基づいた鑑定結果やアドバイスを伝えてください。
            タロットカードの画像（[CARD: ...]）は**絶対に出さないでください**。`;
        }

        systemDirection = `
        【重要指示：ヒアリングと占いの開始判断】
        引き続きヒアリングを行うか、いよいよ占いを行うかを判断してください。

        **以下のいずれかの場合、直ちにヒアリングを終了し、占いを行ってください。**
        1. **相談者が「占って」「結果教えて」など、明確に占いを求めた場合（最優先）。**
        2. あなたが「状況は十分に把握できた、今が占うタイミングだ」と判断した場合。
        3. (会話が長引いているがまだ占っていない場合)「そろそろ見てみましょうか？」と提案し、占いを始める。

        ${divinationInstruction}
        `;
    }

    return { systemDirection, safetyInstruction };
}
