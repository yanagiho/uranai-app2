// アプリ独自の認証フローへつなぐ
        async function handleAuthWithFirebase(firebaseUser) {
            const userId = firebaseUser.uid; // FirebaseのUIDを使う
            const email = firebaseUser.email;
            
            // ローカル保存
            localStorage.setItem('fortune_user_id', userId);
            
            // サーバーへ通知（ユーザー登録/確認）
            // ★修正: headers を追加しました
            const res = await fetch('/api/login', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ userId, email, auth_type: 'Google' }) 
            });
            const data = await res.json();
            
            if (data.isComplete) {
                initApp();
            } else {
                showScreen('setup-screen');
            }
        }
