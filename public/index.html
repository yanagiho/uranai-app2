<script>
    let history = [];
    async function send() {
        const inp = document.getElementById('msg');
        const btn = document.querySelector('button');
        const txt = inp.value.trim();
        if (!txt || btn.disabled) return;
        inp.value = ""; btn.disabled = true;
        addMsg(txt, 'user');

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: txt, history: history })
            });
            const data = await res.json();
            
            // 返ってきたメッセージを表示
            addMsg(data.content, 'asst');
            
            // エラーでなければ履歴に追加
            if (!data.content.includes("APIエラー詳細")) {
                history.push({ role: 'user', content: txt });
                history.push({ role: 'model', content: data.content });
            }
        } catch (e) {
            addMsg("通信エラー: サーバーに接続できませんでした。", 'asst');
        } finally { btn.disabled = false; }
    }
    // ... addMsg などの他の関数はそのまま ...
</script>
