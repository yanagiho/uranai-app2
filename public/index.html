<script>
    // ...ï¼ˆæ—¢å­˜ã®å¤‰æ•°ã¯ç¶­æŒï¼‰

    async function sendMessage(manualText = null) {
        const input = document.getElementById('chat-input'), box = document.getElementById('chat-box');
        const text = manualText !== null ? manualText : input.value;
        if (text && manualText === null) {
            box.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;
        }

        try {
            const res = await fetch('/api/chat', { method: 'POST', body: JSON.stringify({ userId, castId: currentCastId, text }) });
            const data = await res.json();
            
            let reply = data.reply;
            
            // ã€ç”»åƒè¡¨ç¤ºæ¼”å‡ºã®æ ¸ âš¡ã€‘ AIã®è¿”ç­”ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚¿ã‚°ã‚’æ¢ã—ã¦ç”»åƒã«å¤‰æ›
            const cardMatch = reply.match(/\[CARD:\s*(.+?)\]/);
            if (cardMatch) {
                const cardImg = cardMatch[1];
                reply = reply.replace(cardMatch[0], ""); // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¿ã‚°ã‚’æ¶ˆã™
                // ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ã‚†ã£ãã‚Šè¡¨ç¤ºã•ã›ã‚‹HTMLã‚’è¿½åŠ  ğŸƒ
                const imgHtml = `
                    <div style="text-align:center; margin:15px 0; animation: fade-in 1.5s;">
                        <img src="/img/tarot/${cardImg}" style="width:160px; border-radius:10px; border:2px solid var(--gold); box-shadow:0 0 20px var(--gold);">
                    </div>`;
                box.innerHTML += `<div class="msg ai">${reply}${imgHtml}</div>`;
            } else {
                box.innerHTML += `<div class="msg ai">${reply}</div>`;
            }

            box.scrollTop = box.scrollHeight;
        } catch (e) {
            box.innerHTML += `<div class="msg ai" style="color:var(--error)">â€»é€šä¿¡ãŒé€”çµ¶ãˆã¾ã—ãŸã€‚</div>`;
        }
    }
    // ...
</script>

<style>
    @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
