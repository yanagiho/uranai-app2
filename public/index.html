<div id="booking-screen" class="screen">
    <h2>鑑定予約 - <span id="book-cast-name"></span></h2>
    <div class="booking-card">
        <label>1. 鑑定日を選択</label>
        <input type="date" id="book-date" onchange="loadTimeSlots()">
        
        <label>2. 希望の時間を選択（30分刻み）</label>
        <div id="time-slots" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
            </div>
        
        <div id="selection-info" style="margin-top:20px; color:var(--gold); font-weight:bold;"></div>
        <p style="font-size:0.75rem; color:#888;">※人気の先生のため、お早めにご予約ください。</p>
        <button id="confirm-booking-btn" class="main-btn" style="display:none; margin-top:15px;" onclick="submitBooking()">この内容で予約を確定する</button>
    </div>
</div>

<script>
    let selectedSlot = null;

    // 日付が選ばれたら、その日の空き状況をサーバー（体裁上）から取得
    async function loadTimeSlots() {
        const date = document.getElementById('book-date').value;
        const slotsDiv = document.getElementById('time-slots');
        slotsDiv.innerHTML = "読込中...";
        
        // 実際にはAPIから取得。ここでは「人間が占ってる体裁」として一部をランダムに埋める
        const res = await fetch(`/api/get_slots?castId=${currentCastId}&date=${date}`);
        const data = await res.json();
        
        slotsDiv.innerHTML = data.slots.map(s => {
            const isBooked = s.status === 'booked';
            return `
                <button class="slot-btn" ${isBooked ? 'disabled' : ''} 
                    style="padding:10px; border:1px solid ${isBooked ? '#333' : 'var(--gold)'}; 
                    background:${isBooked ? '#111' : 'transparent'}; 
                    color:${isBooked ? '#555' : '#fff'}; border-radius:5px;"
                    onclick="selectTime('${s.time}')">
                    ${s.time} ${isBooked ? '[満席]' : '[空き]'}
                </button>
            `;
        }).join('');
    }

    function selectTime(time) {
        selectedSlot = time;
        document.getElementById('selection-info').innerText = `選択中: ${time}`;
        document.getElementById('confirm-booking-btn').style.display = 'block';
    }

    async function submitBooking() {
        const date = document.getElementById('book-date').value;
        const scheduledAt = `${date}T${selectedSlot}`; // 例: 2025-12-30T18:00
        
        const res = await fetch('/api/reserve', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, castId: currentCastId, scheduledAt })
        });
        const data = await res.json();
        if(data.error) return alert(data.error);
        
        alert("予約を承りました。鑑定時間にお戻りください。");
        location.reload();
    }
</script>
