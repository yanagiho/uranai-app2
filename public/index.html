<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÂç†„ÅÑ„ÅÆÈ§®</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #1a1a2e; color: #fff; margin: 0; padding: 20px; text-align: center; }
        h1 { margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto; }
        .card-cast { background: #16213e; border-radius: 15px; padding: 15px; cursor: pointer; transition: 0.3s; border: 1px solid #0f3460; }
        .card-cast:hover { transform: translateY(-5px); border-color: #e94560; }
        .card-cast img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #e94560; }
        .name { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .desc { font-size: 0.8em; color: #ccc; height: 40px; overflow: hidden; }
        
        /* „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢ */
        #chat-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; }
        .chat-box { width: 90%; max-width: 500px; height: 80%; background: #16213e; margin: 5% auto; border-radius: 10px; display: flex; flex-direction: column; position: relative; }
        .chat-header { padding: 15px; background: #0f3460; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5em; cursor: pointer; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; line-height: 1.4; font-size: 0.9em; text-align: left; }
        .msg.user { align-self: flex-end; background: #e94560; color: #fff; border-bottom-right-radius: 2px; }
        .msg.bot { align-self: flex-start; background: #eee; color: #333; border-bottom-left-radius: 2px; white-space: pre-wrap; }

        .input-area { padding: 15px; background: #0f3460; display: flex; gap: 10px; flex-direction: column; }
        .text-input-row { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        button { padding: 10px 20px; background: #e94560; color: white; border: none; border-radius: 20px; cursor: pointer; white-space: nowrap; }
        button:disabled { background: #555; }

        /* „Çø„É≠„ÉÉ„Éà„Ç´„Éº„ÉâÊºîÂá∫„Ç®„É™„Ç¢ */
        #tarot-stage { display: none; height: 0; transition: 0.5s; overflow: visible; perspective: 1000px; margin-bottom: 10px; justify-content: center; align-items: center; }
        .tarot-card { width: 120px; height: 200px; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .tarot-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; display: flex; justify-content: center; align-items: center; flex-direction: column; box-shadow: 0 0 15px rgba(233, 69, 96, 0.5); border: 2px solid #e94560; background: #222; }
        .tarot-back { background: repeating-linear-gradient(45deg, #1a1a2e, #1a1a2e 10px, #0f3460 10px, #0f3460 20px); }
        .tarot-front { transform: rotateY(180deg); background: #fff; color: #000; padding: 10px; text-align: center; }
        .card-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: #e94560; }
        .card-img-placeholder { font-size: 3em; }

        .flipped { transform: rotateY(180deg); }
        .tarot-btn { background: linear-gradient(135deg, #6a0dad, #9b59b6) !important; width: 100%; margin-bottom: 5px; display: none; font-weight: bold; box-shadow: 0 4px 10px rgba(106, 13, 173, 0.5); } 
    </style>
</head>
<body>

    <h1>üîÆ AIÂç†„ÅÑ„ÅÆÈ§®</h1>
    <div id="cast-list" class="grid">Ë™≠„ÅøËæº„Åø‰∏≠...</div>

    <div id="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span id="chat-title">Âç†„ÅÑÂ∏´</span>
                <button class="close-btn" onclick="closeChat()">√ó</button>
            </div>
            
            <div id="messages"></div>

            <div id="tarot-stage">
                <div class="tarot-card" id="tarot-card-el">
                    <div class="tarot-face tarot-back"></div>
                    <div class="tarot-face tarot-front">
                        <div class="card-img-placeholder">üÉè</div>
                        <div class="card-title" id="card-name">?</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <button onclick="drawCard()" id="tarot-btn" class="tarot-btn">üé¥ „Ç´„Éº„Éâ„ÇíÂºï„ÅÑ„Å¶Âç†„ÅÜ</button>
                <div class="text-input-row">
                    <input type="text" id="user-input" placeholder="ÊÇ©„Åø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...">
                    <button onclick="sendMessage()" id="send-btn">ÈÄÅ‰ø°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imgMap = { 'Á¥´Èõ≤': 'shiun.png', 'ÊòüÂ∑ù„É¨„Ç™„Éä': 'leona.png', 'Â§©ÁÖßÈô¢ ÁÖåÂ§ú': 'koya.png', 'Áê•ÁèÄ': 'kohaku.png', 'Á¢ßÊµ∑„Çµ„Éä': 'sana.png', 'Á¥ÖËìÆ„Éû„É™„Ç¢': 'maria.png', 'Èõ™Èü≥': 'yukine.png', 'ÈªíÊõú„Ç§„ÉÑ„Ç≠': 'itsuki.png' };
        
        const tarotCards = [
            "0. ÊÑöËÄÖ (The Fool)", "I. È≠îË°ìÂ∏´ (The Magician)", "II. Â•≥ÊïôÁöá (The High Priestess)", "III. Â•≥Â∏ù (The Empress)", "IV. ÁöáÂ∏ù (The Emperor)",
            "V. Ê≥ïÁéã (The Hierophant)", "VI. ÊÅã‰∫∫ (The Lovers)", "VII. Êà¶Ëªä (The Chariot)", "VIII. Âäõ (Strength)", "IX. Èö†ËÄÖ (The Hermit)",
            "X. ÈÅãÂëΩ„ÅÆËº™ (Wheel of Fortune)", "XI. Ê≠£Áæ© (Justice)", "XII. Âêä„Çã„Åï„Çå„ÅüÁî∑ (The Hanged Man)", "XIII. Ê≠ªÁ•û (Death)", "XIV. ÁØÄÂà∂ (Temperance)",
            "XV. ÊÇ™È≠î (The Devil)", "XVI. Â°î (The Tower)", "XVII. Êòü (The Star)", "XVIII. Êúà (The Moon)", "XIX. Â§™ÈôΩ (The Sun)",
            "XX. ÂØ©Âà§ (Judgement)", "XXI. ‰∏ñÁïå (The World)"
        ];

        let currentCast = null;
        let drawnCardName = null;

        fetch('/api/casts').then(res => res.json()).then(data => {
            const list = document.getElementById('cast-list');
            list.innerHTML = '';
            data.forEach(cast => {
                const div = document.createElement('div');
                div.className = 'card-cast';
                div.innerHTML = `<img src="/img/${imgMap[cast.name] || 'default.png'}"><div class="name">${cast.name}</div><div class="desc">${cast.system_prompt.substring(0, 30)}...</div>`;
                div.onclick = () => openChat(cast);
                list.appendChild(div);
            });
        });

        function openChat(cast) {
            currentCast = cast;
            drawnCardName = null;
            document.getElementById('chat-title').innerText = cast.name;
            document.getElementById('messages').innerHTML = `<div class="msg bot">„Çà„ÅÜ„Åì„Åù„ÄÅ${cast.name}„Åß„Åô„ÄÇ\nÊÇ©„Åø„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ</div>`;
            document.getElementById('chat-modal').style.display = 'block';
            
            const tarotBtn = document.getElementById('tarot-btn');
            const sendBtn = document.getElementById('send-btn');
            const stage = document.getElementById('tarot-stage');
            
            stage.style.display = 'none';
            stage.style.height = '0';
            document.getElementById('tarot-card-el').classList.remove('flipped'); 

            if (cast.name.includes('Á¥´Èõ≤')) {
                tarotBtn.style.display = 'block';
                sendBtn.style.display = 'none'; 
                document.getElementById('user-input').placeholder = "ÊÇ©„Åø„ÇíÂÖ•Âäõ„Åó„Å¶„ÄÅ„Ç´„Éº„Éâ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Å≠";
            } else {
                tarotBtn.style.display = 'none';
                sendBtn.style.display = 'block';
                document.getElementById('user-input').placeholder = "ÊÇ©„Åø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...";
            }
        }

        function closeChat() {
            document.getElementById('chat-modal').style.display = 'none';
        }

        function drawCard() {
            const stage = document.getElementById('tarot-stage');
            const cardEl = document.getElementById('tarot-card-el');
            const cardNameEl = document.getElementById('card-name');
            const input = document.getElementById('user-input');

            if(!input.value) { alert("ÂÖà„Å´ÊÇ©„Åø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ"); return; }

            stage.style.display = 'none';
            cardEl.classList.remove('flipped');
            void cardEl.offsetWidth; 

            stage.style.display = 'flex';
            stage.style.height = '220px';
            
            const randomCard = tarotCards[Math.floor(Math.random() * tarotCards.length)];
            drawnCardName = randomCard;
            cardNameEl.innerText = randomCard;

            setTimeout(() => {
                cardEl.classList.add('flipped');
            }, 100);

            setTimeout(() => {
                sendMessage();
            }, 2000);
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const text = input.value;
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';
            document.getElementById('tarot-btn').disabled = true;

            if (drawnCardName) {
                addMessage(`(„Ç´„Éº„Éâ„ÇíÂºï„Åç„Åæ„Åó„Åü: ${drawnCardName})`, 'user');
                sendBtn.style.display = 'block';
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: text, 
                        castId: currentCast.id,
                        cardName: drawnCardName 
                    })
                });
                const data = await res.json();
                addMessage(data.reply, 'bot');
            } catch (e) {
                addMessage('„Ç®„É©„Éº: ' + e, 'bot');
            }
            
            drawnCardName = null;
            document.getElementById('tarot-btn').disabled = false;
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
