<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå ã„ã®é¤¨</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #1a1a2e; color: #fff; margin: 0; padding: 20px; text-align: center; }
        h1 { margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto; }
        .card-cast { background: #16213e; border-radius: 15px; padding: 15px; cursor: pointer; transition: 0.3s; border: 1px solid #0f3460; }
        .card-cast:hover { transform: translateY(-5px); border-color: #e94560; }
        .card-cast img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #e94560; }
        .name { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .desc { font-size: 0.8em; color: #ccc; height: 40px; overflow: hidden; }
        
        /* ãƒãƒ£ãƒƒãƒˆç”»é¢ */
        #chat-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; }
        .chat-box { width: 90%; max-width: 500px; height: 80%; background: #16213e; margin: 5% auto; border-radius: 10px; display: flex; flex-direction: column; position: relative; }
        .chat-header { padding: 15px; background: #0f3460; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5em; cursor: pointer; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¹ãå‡ºã— */
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; line-height: 1.4; font-size: 0.9em; text-align: left; }
        .msg.user { align-self: flex-end; background: #e94560; color: #fff; border-bottom-right-radius: 2px; }
        .msg.bot { align-self: flex-start; background: #eee; color: #333; border-bottom-left-radius: 2px; white-space: pre-wrap; }

        .input-area { padding: 15px; background: #0f3460; display: flex; gap: 10px; flex-direction: column; }
        .text-input-row { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        button { padding: 10px 20px; background: #e94560; color: white; border: none; border-radius: 20px; cursor: pointer; }
        button:disabled { background: #555; }

        /* â˜…ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ¼”å‡ºã‚¨ãƒªã‚¢ */
        #tarot-stage { display: none; height: 0; transition: 0.5s; overflow: visible; perspective: 1000px; margin-bottom: 10px; justify-content: center; align-items: center; }
        .tarot-card { width: 120px; height: 200px; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .tarot-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; display: flex; justify-content: center; align-items: center; flex-direction: column; box-shadow: 0 0 15px rgba(233, 69, 96, 0.5); border: 2px solid #e94560; background: #222; }
        .tarot-back { background: repeating-linear-gradient(45deg, #1a1a2e, #1a1a2e 10px, #0f3460 10px, #0f3460 20px); }
        .tarot-front { transform: rotateY(180deg); background: #fff; color: #000; padding: 10px; text-align: center; }
        .card-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: #e94560; }
        .card-img-placeholder { font-size: 3em; }

        .flipped { transform: rotateY(180deg); }
        .tarot-btn { background: #6a0dad !important; width: 100%; margin-bottom: 5px; display: none; } /* ç´«é›²å°‚ç”¨ãƒœã‚¿ãƒ³ */
    </style>
</head>
<body>

    <h1>ğŸ”® AIå ã„ã®é¤¨</h1>
    <div id="cast-list" class="grid">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span id="chat-title">å ã„å¸«</span>
                <button class="close-btn" onclick="closeChat()">Ã—</button>
            </div>
            
            <div id="messages"></div>

            <div id="tarot-stage">
                <div class="tarot-card" id="tarot-card-el">
                    <div class="tarot-face tarot-back"></div>
                    <div class="tarot-face tarot-front">
                        <div class="card-img-placeholder">ğŸƒ</div>
                        <div class="card-title" id="card-name">æ„šè€…</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <button onclick="drawCard()" id="tarot-btn" class="tarot-btn">ğŸ´ ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦å ã†</button>
                <div class="text-input-row">
                    <input type="text" id="user-input" placeholder="æ‚©ã¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
                    <button onclick="sendMessage()" id="send-btn">é€ä¿¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imgMap = { 'ç´«é›²': 'shiun.png', 'æ˜Ÿå·ãƒ¬ã‚ªãƒŠ': 'leona.png', 'å¤©ç…§é™¢ ç…Œå¤œ': 'koya.png', 'ç¥ç€': 'kohaku.png', 'ç¢§æµ·ã‚µãƒŠ': 'sana.png', 'ç´…è“®ãƒãƒªã‚¢': 'maria.png', 'é›ªéŸ³': 'yukine.png', 'é»’æ›œã‚¤ãƒ„ã‚­': 'itsuki.png' };
        
        // ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰å¤§ã‚¢ãƒ«ã‚«ãƒŠ22æš
        const tarotCards = [
            "0. æ„šè€… (The Fool)", "I. é­”è¡“å¸« (The Magician)", "II. å¥³æ•™çš‡ (The High Priestess)", "III. å¥³å¸ (The Empress)", "IV. çš‡å¸ (The Emperor)",
            "V. æ³•ç‹ (The Hierophant)", "VI. æ‹äºº (The Lovers)", "VII. æˆ¦è»Š (The Chariot)", "VIII. åŠ› (Strength)", "IX. éš è€… (The Hermit)",
            "X. é‹å‘½ã®è¼ª (Wheel of Fortune)", "XI. æ­£ç¾© (Justice)", "XII. åŠã‚‹ã•ã‚ŒãŸç”· (The Hanged Man)", "XIII. æ­»ç¥ (Death)", "XIV. ç¯€åˆ¶ (Temperance)",
            "XV. æ‚ªé­” (The Devil)", "XVI. å¡” (The Tower)", "XVII. æ˜Ÿ (The Star)", "XVIII. æœˆ (The Moon)", "XIX. å¤ªé™½ (The Sun)",
            "XX. å¯©åˆ¤ (Judgement)", "XXI. ä¸–ç•Œ (The World)"
        ];

        let currentCast = null;
        let drawnCardName = null;

        // 1. å ã„å¸«ä¸€è¦§
        fetch('/api/casts').then(res => res.json()).then(data => {
            const list = document.getElementById('cast-list');
            list.innerHTML = '';
            data.forEach(cast => {
                const div = document.createElement('div');
                div.className = 'card-cast';
                div.innerHTML = `<img src="/img/${imgMap[cast.name] || 'default.png'}"><div class="name">${cast.name}</div><div class="desc">${cast.system_prompt.substring(0, 30)}...</div>`;
                div.onclick = () => openChat(cast);
                list.appendChild(div);
            });
        });

        function openChat(cast) {
            currentCast = cast;
            drawnCardName = null;
            document.getElementById('chat-title').innerText = cast.name;
            document.getElementById('messages').innerHTML = `<div class="msg bot">ã‚ˆã†ã“ãã€${cast.name}ã§ã™ã€‚\næ‚©ã¿ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚</div>`;
            document.getElementById('chat-modal').style.display = 'block';
            
            // UIè¦ç´ ã®å–å¾—
            const tarotBtn = document.getElementById('tarot-btn');
            const sendBtn = document.getElementById('send-btn');
            const stage = document.getElementById('tarot-stage');
            
            // ãƒªã‚»ãƒƒãƒˆ
            stage.style.height = '0'; 
            document.getElementById('tarot-card-el').classList.remove('flipped'); 

            // â˜…ç´«é›²ã®å ´åˆã ã‘ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            if (cast.name.includes('ç´«é›²')) {
                tarotBtn.style.display = 'block';
                sendBtn.style.display = 'none'; // æœ€åˆã¯é€ä¿¡ãƒœã‚¿ãƒ³ã‚’éš ã™ï¼
            } else {
                tarotBtn.style.display = 'none';
                sendBtn.style.display = 'block';
            }
        }

        function closeChat() {
            document.getElementById('chat-modal').style.display = 'none';
        }

        // 2. ã‚¿ãƒ­ãƒƒãƒˆã‚’å¼•ãï¼ˆæ¼”å‡ºã®ã¿ï¼‰
        function drawCard() {
            const stage = document.getElementById('tarot-stage');
            const cardEl = document.getElementById('tarot-card-el');
            const cardNameEl = document.getElementById('card-name');
            const input = document.getElementById('user-input');

            if(!input.value) { alert("å…ˆã«æ‚©ã¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }

            // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            stage.style.display = 'flex';
            stage.style.height = '220px';
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶
            const randomCard = tarotCards[Math.floor(Math.random() * tarotCards.length)];
            drawnCardName = randomCard;
            cardNameEl.innerText = randomCard;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚ãã‚‹
            setTimeout(() => {
                cardEl.classList.add('flipped');
            }, 500);

            // ã•ã‚‰ã«å¾…ã£ã¦ã‹ã‚‰è‡ªå‹•é€ä¿¡
            setTimeout(() => {
                sendMessage();
            }, 2000);
        }

        // 3. é€ä¿¡
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const text = input.value;
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';
            document.getElementById('tarot-btn').disabled = true;

            // ã‚¿ãƒ­ãƒƒãƒˆãŒå¼•ã‹ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¡¨ç¤º
            if (drawnCardName) {
                addMessage(`(ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã—ãŸ: ${drawnCardName})`, 'user');
                
                // â˜…ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸå¾Œã¯ã€é€šå¸¸ã®é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å¾©æ´»ã•ã›ã‚‹ï¼ˆä¼šè©±ã‚’ç¶šã‘ã‚‹ãŸã‚ï¼‰
                sendBtn.style.display = 'block';
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: text, 
                        castId: currentCast.id,
                        cardName: drawnCardName // å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã‚’é€ã‚‹ï¼ˆãªã‘ã‚Œã°nullï¼‰
                    })
                });
                const data = await res.json();
                addMessage(data.reply, 'bot');
            } catch (e) {
                addMessage('ã‚¨ãƒ©ãƒ¼: ' + e, 'bot');
            }
            
            // ãƒªã‚»ãƒƒãƒˆ
            drawnCardName = null;
            document.getElementById('tarot-btn').disabled = false;
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
