<script>
        let userId = localStorage.getItem('fortune_user_id');
        let currentCastId = null, selectedDate = null, selectedTime = null, currentAuthType = "", tempEmail = "";

        // ページ読み込み時の処理
        window.onload = async () => { 
            if (userId) {
                // すでにIDがある場合、サーバーに「登録が完了しているか」を確認する
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: userId, auth_type: 'Session' })
                });
                const data = await res.json();
                
                if (data.isComplete) {
                    initApp(); // 登録済みなら占い師一覧へ
                } else {
                    showScreen('setup-screen'); // 未登録なら登録画面へ強制移動
                }
            } else {
                showScreen('gateway-screen'); 
            }
        };

        // SNS/メール 認証処理
        async function handleAuth(type) {
            currentAuthType = type;
            const email = document.getElementById('login-email').value.trim();
            if (type === 'Email' && !email) return alert("メールアドレスを入力してください");

            // 新規または既存のIDを決定
            const simId = type === 'Email' ? 'e_' + btoa(email) : (userId || 's_' + Math.random().toString(36).substr(2, 9));
            tempEmail = email;

            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: type==='Email'?email:'', auth_type: type, userId: simId })
            });
            const data = await res.json();
            
            userId = simId;
            localStorage.setItem('fortune_user_id', userId);

            if (data.isComplete) {
                initApp();
            } else {
                showScreen('setup-screen');
            }
        }

        async function register() {
            const name = document.getElementById('user-name').value.trim();
            const dob = document.getElementById('user-dob').value;
            if (!name || !dob) return alert("お名前と生年月日を入力してください");

            const res = await fetch('/api/save_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, name, dob, email: tempEmail, auth_type: currentAuthType })
            });
            
            if (res.ok) {
                initApp();
            } else {
                alert("登録に失敗しました。");
            }
        }

        async function initApp() {
            const res = await fetch(`/api/user_info?userId=${userId}`);
            const data = await res.json();
            
            // ユーザーが存在しない（DBリセット後など）場合は登録画面へ
            if (data.name === "ゲスト") {
                showScreen('setup-screen');
                return;
            }

            document.getElementById('nav-ticket').innerText = data.ticket_balance || 0;
            showScreen('selection-screen');
            document.getElementById('main-nav').style.display = 'flex';
            
            const cres = await fetch('/api/casts');
            const casts = await cres.json();
            document.getElementById('cast-list').innerHTML = casts.map(c => `
                <div class="cast-card" onclick="openBooking(${c.id}, '${c.name}')">
                    <img src="/img/${c.img}">
                    <strong>${c.name}</strong><br><small style="color:#888">${c.role}</small>
                </div>
            `).join('');
        }

        // --- 画面切り替え ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            const target = document.getElementById(id);
            if (target) target.style.display = 'flex'; // gatewayはflex、他はblockなど調整が必要ならここで行う
            
            if (id === 'gateway-screen' || id === 'title-screen' || id === 'setup-screen') {
                document.getElementById('main-nav').style.display = 'none';
            } else {
                document.getElementById('main-nav').style.display = 'flex';
            }
        }

        // --- 予約関連の既存ロジック ---
        function openBooking(id, name) {
            currentCastId = id;
            document.getElementById('book-cast-name').innerText = name + " 鑑定予約";
            const list = document.getElementById('day-list');
            list.innerHTML = "";
            for (let i = 0; i < 7; i++) {
                const d = new Date(); d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                list.innerHTML += `<div class="day-tab" onclick="selectDay('${dateStr}', this)">${i===0?'今日':(d.getMonth()+1)+'/'+d.getDate()}</div>`;
            }
            showScreen('booking-screen');
            document.getElementById('booking-screen').style.display = 'block'; // bookingは中央寄せのためblock
        }

        async function selectDay(date, el) {
            selectedDate = date;
            document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            const slotsDiv = document.getElementById('time-slots');
            slotsDiv.innerHTML = "<div style='grid-column:1/4; padding:20px;'>星に聞いています...</div>";
            const res = await fetch(`/api/get_slots?castId=${currentCastId}&date=${date}`);
            const data = await res.json();
            slotsDiv.innerHTML = data.slots.map(s => 
                `<button style="padding:10px; background:none; border:1px solid var(--gold); color:#fff; border-radius:5px; opacity:${s.status==='available'?'1':'0.3'}" ${s.status!=='available'?'disabled':''} onclick="selectTime('${s.time}', this)">${s.status==='booked'?'予約済':s.time}</button>`
            ).join('');
        }

        function selectTime(time, el) {
            selectedTime = time;
            document.querySelectorAll('#time-slots button').forEach(b => b.style.background = 'none');
            el.style.background = 'var(--gold)'; el.style.color = '#000';
            document.getElementById('confirm-btn').style.display = 'block';
        }

        async function submitBooking() {
            await fetch('/api/reserve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, castId: currentCastId, scheduledAt: `${selectedDate}T${selectedTime}` })
            });
            alert("予約が完了しました。メールをご確認ください。");
            location.reload();
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
