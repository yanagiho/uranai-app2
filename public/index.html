<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå ã„ã®é¤¨</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #1a1a2e; color: #fff; margin: 0; padding: 20px; text-align: center; }
        h1 { margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto; }
        .card { background: #16213e; border-radius: 15px; padding: 15px; cursor: pointer; transition: 0.3s; border: 1px solid #0f3460; }
        .card:hover { transform: translateY(-5px); border-color: #e94560; }
        .card img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #e94560; }
        .name { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .desc { font-size: 0.8em; color: #ccc; height: 40px; overflow: hidden; }
        
        /* ãƒãƒ£ãƒƒãƒˆç”»é¢ */
        #chat-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; }
        .chat-box { width: 90%; max-width: 500px; height: 80%; background: #16213e; margin: 5% auto; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { padding: 15px; background: #0f3460; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5em; cursor: pointer; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; line-height: 1.4; font-size: 0.9em; }
        .msg.user { align-self: flex-end; background: #e94560; color: #fff; border-bottom-right-radius: 2px; }
        .msg.bot { align-self: flex-start; background: #eee; color: #333; border-bottom-left-radius: 2px; white-space: pre-wrap; }
        .input-area { padding: 15px; background: #0f3460; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        button { padding: 10px 20px; background: #e94560; color: white; border: none; border-radius: 20px; cursor: pointer; }
        button:disabled { background: #555; }
    </style>
</head>
<body>

    <h1>ğŸ”® AIå ã„ã®é¤¨</h1>
    <div id="cast-list" class="grid">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span id="chat-title">å ã„å¸«</span>
                <button class="close-btn" onclick="closeChat()">Ã—</button>
            </div>
            <div id="messages"></div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="æ‚©ã¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
                <button onclick="sendMessage()" id="send-btn">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <script>
        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæ—¥æœ¬èªå â†’ ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
        const imgMap = {
            'ç´«é›²': 'shiun.png', 'æ˜Ÿå·ãƒ¬ã‚ªãƒŠ': 'leona.png', 'å¤©ç…§é™¢ ç…Œå¤œ': 'koya.png',
            'ç¥ç€': 'kohaku.png', 'ç¢§æµ·ã‚µãƒŠ': 'sana.png', 'ç´…è“®ãƒãƒªã‚¢': 'maria.png',
            'é›ªéŸ³': 'yukine.png', 'é»’æ›œã‚¤ãƒ„ã‚­': 'itsuki.png'
        };

        let currentCastId = null;

        // 1. å ã„å¸«ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        fetch('/api/casts')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('cast-list');
                list.innerHTML = '';
                data.forEach(cast => {
                    const imgFile = imgMap[cast.name] || 'default.png';
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="/img/${imgFile}" alt="${cast.name}">
                        <div class="name">${cast.name}</div>
                        <div class="desc">${cast.system_prompt.substring(10, 40)}...</div>
                    `;
                    div.onclick = () => openChat(cast);
                    list.appendChild(div);
                });
            })
            .catch(err => {
                document.getElementById('cast-list').innerText = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err;
            });

        // 2. ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
        function openChat(cast) {
            currentCastId = cast.id;
            document.getElementById('chat-title').innerText = cast.name;
            document.getElementById('messages').innerHTML = `<div class="msg bot">ã‚ˆã†ã“ãã€${cast.name}ã§ã™ã€‚\nä½•ã‹ãŠæ‚©ã¿ã§ã™ã‹ï¼Ÿ</div>`;
            document.getElementById('chat-modal').style.display = 'block';
        }

        function closeChat() {
            document.getElementById('chat-modal').style.display = 'none';
        }

        // 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const text = input.value;
            if (!text) return;

            // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage(text, 'user');
            input.value = '';
            btn.disabled = true;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text, castId: currentCastId })
                });
                const data = await res.json();
                addMessage(data.reply, 'bot');
            } catch (e) {
                addMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'bot');
            }
            btn.disabled = false;
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
